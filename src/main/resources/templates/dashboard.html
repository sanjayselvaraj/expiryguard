<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpiryGuard - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-shield-lock brand-logo"></i>
                ExpiryGuard
            </a>
            <div class="navbar-nav ms-auto">
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Summary Cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="stat-card bg-primary text-white">
                    <div class="stat-number" th:text="${#lists.size(secrets)}">0</div>
                    <div class="stat-label">Total Secrets</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-warning text-dark">
                    <div class="stat-number" th:text="${expiringSoon}">0</div>
                    <div class="stat-label">Expiring in 7 Days</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-danger text-white">
                    <div class="stat-number" th:text="${urgent}">0</div>
                    <div class="stat-label">Urgent (â‰¤3 Days)</div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Your Secrets</h2>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSecretModal">
                    <i class="bi bi-plus-lg"></i> Add Secret
                </button>
            </div>
        </div>

        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="alert alert-warning">
            <strong>Warning:</strong> Do NOT store actual secret values. This system only tracks metadata (names and
            expiry dates).
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Secret Name</th>
                        <th>Expiry Date</th>
                        <th>Days Remaining</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="secret : ${secrets}"
                        th:class="${daysRemaining.get(secret.id) < 7} ? 'table-danger' : (${daysRemaining.get(secret.id) < 30} ? 'table-warning' : '')">
                        <td th:text="${secret.name}"></td>
                        <td th:text="${secret.expiryDate}"></td>
                        <td th:text="${daysRemaining.get(secret.id)}"></td>
                        <td th:text="${secret.notes ?: '-'}"></td>
                        <td>
                            <form th:action="@{/secrets/delete}" method="post" class="d-inline">
                                <input type="hidden" name="secretId" th:value="${secret.id}">
                                <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this secret?')">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(secrets)}">
                        <td colspan="5" class="text-center text-muted">No secrets found. Add your first secret!</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Secret Modal -->
    <div class="modal fade" id="addSecretModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Secret</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/secrets/add}" method="post" id="secretForm">
                    <div class="modal-body">
                        <!-- Certificate Import Zone -->
                        <div class="mb-4">
                            <label class="form-label">Import Certificate (Optional)</label>
                            <div class="cert-drop-zone" id="certDropZone">
                                <div id="dropZoneContent">
                                    <i class="bi bi-file-earmark-lock" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="mb-2">Drag & drop certificate file here</p>
                                    <p class="mb-2">or <span class="text-primary">click to browse</span></p>
                                    <small class="text-muted">Supports .p12, .pem, .cer files</small>
                                </div>
                                <div id="successContent" style="display: none;">
                                    <i class="bi bi-check-circle" style="font-size: 2rem; color: #198754;"></i>
                                    <p class="mb-0 text-success">Certificate parsed successfully!</p>
                                </div>
                                <input type="file" id="certFileInput" accept=".p12,.pem,.cer,.crt,.pfx">
                            </div>
                            <div class="security-notice">
                                ðŸ”’ Processed in your browser. The file is never uploaded.
                            </div>
                            <div id="parseError" class="text-muted mt-2" style="display: none;">
                                Could not parse certificate. Please fill the form manually.
                            </div>
                        </div>

                        <!-- Manual Form Fields -->
                        <div class="mb-3">
                            <label for="name" class="form-label">Secret Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="expiryDate" name="expiryDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Secret</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/certificate-parser.js}"></script>
</body>

</html>